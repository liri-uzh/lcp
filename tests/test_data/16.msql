WITH preps AS (SELECT DISTINCT ps."utterance_id", ps.id_offset, ps.content, ps.annotations, s2.char_range
        FROM ofrom.utterancerest s1
        JOIN ofrom."interview" c ON c.char_range @> s1.char_range
        JOIN ofrom.utterance0 s2 ON c.char_range @> s2.char_range AND s2.char_range && int4range(lower(s1.char_range) - 2, upper(s1.char_range) + 2)
        JOIN ofrom.prepared_Utterance ps ON ps."utterance_id" = s2."utterance_id"
        WHERE s1."utterance_id" = ANY(:sids)
        ORDER BY s2.char_range),
meta AS (WITH "x" AS (SELECT ps.char_range, ps."utterance_id" FROM preps ps),
"Interview" AS (SELECT array_agg("x"."utterance_id") AS "_sids", "Interview"."interview_id" AS "Interview_id","Interview"."char_range" AS "char_range","Interview"."frame_range" AS "frame_range","Interview_audio"."audio" AS "audio","Interview_duree"."duree" AS "duree","Interview"."genre" AS "genre","Interview"."qualite" AS "qualite","Interview_filename"."filename" AS "filename","Interview_reviseur"."reviseur" AS "reviseur","Interview_enqueteur"."enqueteur" AS "enqueteur","Interview"."sousCorpus" AS "sousCorpus","Interview"."universite" AS "universite","Interview"."responsable" AS "responsable","Interview_dateRevision"."dateRevision" AS "dateRevision","Interview_transcripteur"."transcripteur" AS "transcripteur","Interview_dateEnregistrement"."dateEnregistrement" AS "dateEnregistrement","Interview_lieuEnregistrement"."lieuEnregistrement" AS "lieuEnregistrement","Interview"."regionEnregistrement" AS "regionEnregistrement","Interview"."media"::jsonb AS "media","Interview"."name"::text AS "name" FROM "x"LEFT JOIN "ofrom"."interview" "Interview" ON "Interview"."char_range" && "x"."char_range" LEFT JOIN "ofrom"."interview_audio" "Interview_audio" ON "Interview_audio"."audio_id" = "Interview"."audio_id" LEFT JOIN "ofrom"."interview_duree" "Interview_duree" ON "Interview_duree"."duree_id" = "Interview"."duree_id" LEFT JOIN "ofrom"."interview_filename" "Interview_filename" ON "Interview_filename"."filename_id" = "Interview"."filename_id" LEFT JOIN "ofrom"."interview_reviseur" "Interview_reviseur" ON "Interview_reviseur"."reviseur_id" = "Interview"."reviseur_id" LEFT JOIN "ofrom"."interview_enqueteur" "Interview_enqueteur" ON "Interview_enqueteur"."enqueteur_id" = "Interview"."enqueteur_id" LEFT JOIN "ofrom"."interview_daterevision" "Interview_dateRevision" ON "Interview_dateRevision"."dateRevision_id" = "Interview"."dateRevision_id" LEFT JOIN "ofrom"."interview_transcripteur" "Interview_transcripteur" ON "Interview_transcripteur"."transcripteur_id" = "Interview"."transcripteur_id" LEFT JOIN "ofrom"."interview_dateenregistrement" "Interview_dateEnregistrement" ON "Interview_dateEnregistrement"."dateEnregistrement_id" = "Interview"."dateEnregistrement_id" LEFT JOIN "ofrom"."interview_lieuenregistrement" "Interview_lieuEnregistrement" ON "Interview_lieuEnregistrement"."lieuEnregistrement_id" = "Interview"."lieuEnregistrement_id" GROUP BY "Interview_id","Interview_audio"."audio_id","Interview_duree"."duree_id","Interview_filename"."filename_id","Interview_reviseur"."reviseur_id","Interview_enqueteur"."enqueteur_id","Interview_dateRevision"."dateRevision_id","Interview_transcripteur"."transcripteur_id","Interview_dateEnregistrement"."dateEnregistrement_id","Interview_lieuEnregistrement"."lieuEnregistrement_id"),
"Utterance" AS (SELECT array_agg("x"."utterance_id") AS "_sids", "Utterance"."utterance_id" AS "Utterance_id","Utterance"."char_range" AS "char_range","Utterance"."frame_range" AS "frame_range","Utterance"."ana" AS "ana","Utterance_text"."text" AS "text","Utterance_agent"."agent" AS "agent","Utterance_xmlid"."xmlid" AS "xmlid" FROM "x"LEFT JOIN "ofrom"."utterance0" "Utterance" ON "Utterance"."char_range" && "x"."char_range" LEFT JOIN "ofrom"."utterance_text" "Utterance_text" ON "Utterance_text"."text_id" = "Utterance"."text_id" LEFT JOIN "ofrom"."global_attribute_agent" "Utterance_agent" ON "Utterance_agent"."agent_id" = "Utterance"."agent_id" LEFT JOIN "ofrom"."utterance_xmlid" "Utterance_xmlid" ON "Utterance_xmlid"."xmlid_id" = "Utterance"."xmlid_id" GROUP BY "Utterance_id","Utterance_text"."text_id","Utterance_agent"."agent_id","Utterance_xmlid"."xmlid_id")
SELECT jsonb_build_array("_sids",'Interview',"Interview_id",jsonb_build_object('char_range',"Interview"."char_range",'frame_range',"Interview"."frame_range",'audio',"Interview"."audio",'duree',"Interview"."duree",'genre',"Interview"."genre",'qualite',"Interview"."qualite",'filename',"Interview"."filename",'reviseur',"Interview"."reviseur",'enqueteur',"Interview"."enqueteur",'sousCorpus',"Interview"."sousCorpus",'universite',"Interview"."universite",'responsable',"Interview"."responsable",'dateRevision',"Interview"."dateRevision",'transcripteur',"Interview"."transcripteur",'dateEnregistrement',"Interview"."dateEnregistrement",'lieuEnregistrement',"Interview"."lieuEnregistrement",'regionEnregistrement',"Interview"."regionEnregistrement",'media',"Interview"."media",'name',"Interview"."name")) AS res FROM "Interview"
UNION ALL SELECT jsonb_build_array("_sids",'Utterance',"Utterance_id",jsonb_build_object('char_range',"Utterance"."char_range",'frame_range',"Utterance"."frame_range",'ana',"Utterance"."ana",'text',"Utterance"."text",'agent',"Utterance"."agent",'xmlid',"Utterance"."xmlid")) AS res FROM "Utterance")
SELECT -1::int2 AS rstype, jsonb_build_array(preps."utterance_id", preps.id_offset, preps.content, preps.annotations, preps.char_range) FROM preps
UNION ALL
SELECT -2::int2 AS rstype, res FROM meta;
