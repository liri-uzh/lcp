WITH preps AS (SELECT Segment_id, id_offset, content FROM candor__5003f209a11e4737ae21a00cb8857736_3.prepared_Segment WHERE Segment_id = ANY(:sids)),
meta AS (WITH "x" AS (SELECT s.char_range, s."segment_id" FROM preps JOIN candor__5003f209a11e4737ae21a00cb8857736_3.segmentrest s ON s."segment_id" = preps."segment_id"),
"Segment" AS (SELECT x."segment_id" AS "_id", "Segment"."segment_id" AS "Segment_id","Segment"."char_range" AS "char_range","Segment"."frame_range" AS "frame_range","Segment"."f0_avg" AS "f0_avg","Segment"."f0_max" AS "f0_max","Segment"."f0_min" AS "f0_min","Segment_speaker"."speaker" AS "speaker","Segment"."intensity_avg" AS "intensity_avg","Segment"."intensity_max" AS "intensity_max","Segment"."intensity_min" AS "intensity_min","Segment"."meta"::jsonb->'end' AS "end","Segment"."meta"::jsonb->'text' AS "text","Segment"."meta"::jsonb->'start' AS "start","Segment"."meta"::jsonb->'channel' AS "channel" FROM "x" LEFT JOIN "candor__5003f209a11e4737ae21a00cb8857736_3"."segmentrest" "Segment" ON "Segment"."char_range" && "x"."char_range" LEFT JOIN "candor__5003f209a11e4737ae21a00cb8857736_3"."global_attribute_speaker" "Segment_speaker" ON "Segment_speaker"."speaker_id" = "Segment"."speaker_id"),
"Document" AS (SELECT x."segment_id" AS "_id", "Document"."document_id" AS "Document_id","Document"."char_range" AS "char_range","Document"."frame_range" AS "frame_range","Document_speaker_L"."speaker" AS "speaker_L","Document_speaker_R"."speaker" AS "speaker_R","Document"."meta"::jsonb->'end' AS "end","Document"."meta"::jsonb->'date' AS "date","Document"."meta"->>'name' AS "name","Document"."meta"::jsonb->'start' AS "start","Document"."media"::jsonb AS "media" FROM "x" LEFT JOIN "candor__5003f209a11e4737ae21a00cb8857736_3"."document" "Document" ON "Document"."char_range" && "x"."char_range" LEFT JOIN "candor__5003f209a11e4737ae21a00cb8857736_3"."global_attribute_speaker" "Document_speaker_L" ON "Document_speaker_L"."speaker_id" = "Document"."speaker_l_id" LEFT JOIN "candor__5003f209a11e4737ae21a00cb8857736_3"."global_attribute_speaker" "Document_speaker_R" ON "Document_speaker_R"."speaker_id" = "Document"."speaker_r_id")
SELECT jsonb_build_array("_id",'Segment',"Segment_id",jsonb_build_object('char_range',"Segment"."char_range",'frame_range',"Segment"."frame_range",'f0_avg',"Segment"."f0_avg",'f0_max',"Segment"."f0_max",'f0_min',"Segment"."f0_min",'speaker',"Segment"."speaker",'intensity_avg',"Segment"."intensity_avg",'intensity_max',"Segment"."intensity_max",'intensity_min',"Segment"."intensity_min",'end',"Segment"."end",'text',"Segment"."text",'start',"Segment"."start",'channel',"Segment"."channel")) AS res FROM "Segment"
UNION ALL SELECT jsonb_build_array("_id",'Document',"Document_id",jsonb_build_object('char_range',"Document"."char_range",'frame_range',"Document"."frame_range",'speaker_L',"Document"."speaker_L",'speaker_R',"Document"."speaker_R",'end',"Document"."end",'date',"Document"."date",'name',"Document"."name",'start',"Document"."start",'media',"Document"."media")) AS res FROM "Document")
SELECT -1::int2 AS rstype, jsonb_build_array(preps."segment_id", preps.id_offset, preps.content) FROM preps
UNION ALL
SELECT -2::int2 AS rstype, res FROM meta;
