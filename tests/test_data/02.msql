WITH preps AS (SELECT DISTINCT ps."segment_id", ps.id_offset, ps.content, jsonb_build_object() AS annotations, s2.char_range
        FROM sparcling1.segment_enrest s1
        JOIN sparcling1."chapter_en" c ON c.char_range @> s1.char_range
        JOIN sparcling1.segment_en0 s2 ON c.char_range @> s2.char_range AND s2.char_range && int4range(lower(s1.char_range) - 2, upper(s1.char_range) + 2)
        JOIN sparcling1.prepared_segment_en ps ON ps."segment_id" = s2."segment_id"
        WHERE s1."segment_id" = ANY(:sids)
        ORDER BY s2.char_range),
meta AS (WITH "x" AS (SELECT ps.char_range, ps."segment_id" FROM preps ps),
"Turn" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Turn"."alignment_id" AS "Turn_id","Turn"."char_range" AS "char_range","Turn_aligned"."meta"::jsonb->'surname' AS "surname","Turn_aligned"."meta"::jsonb->'forename' AS "forename","Turn_aligned"."meta"::jsonb->'memberId' AS "memberId","Turn_aligned"."meta"::jsonb->'countryCode' AS "countryCode","Turn_aligned"."meta"::jsonb->'isPresident' AS "isPresident","Turn_aligned"."meta"::jsonb->'politicalGroup' AS "politicalGroup","Turn_aligned"."meta"::jsonb->'originalLanguage' AS "originalLanguage" FROM "x"LEFT JOIN "sparcling1"."turn_en" "Turn" ON "Turn"."char_range" && "x"."char_range" LEFT JOIN "sparcling1"."turn_alignment" "Turn_aligned" ON "Turn"."alignment_id" = "Turn_aligned"."alignment_id" GROUP BY "Turn_id","Turn_aligned"."alignment_id"),
"Segment" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Segment"."segment_id" AS "Segment_id","Segment"."char_range" AS "char_range" FROM "x"LEFT JOIN "sparcling1"."segment_en0" "Segment" ON "Segment"."char_range" && "x"."char_range" GROUP BY "Segment_id"),
"Chapter" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Chapter"."alignment_id" AS "Chapter_id","Chapter"."char_range" AS "char_range" FROM "x"LEFT JOIN "sparcling1"."chapter_en" "Chapter" ON "Chapter"."char_range" && "x"."char_range" GROUP BY "Chapter_id"),
"Session" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Session"."alignment_id" AS "Session_id","Session"."char_range" AS "char_range","Session_aligned"."meta"::jsonb->'date' AS "date" FROM "x"LEFT JOIN "sparcling1"."session_en" "Session" ON "Session"."char_range" && "x"."char_range" LEFT JOIN "sparcling1"."session_alignment" "Session_aligned" ON "Session"."alignment_id" = "Session_aligned"."alignment_id" GROUP BY "Session_id","Session_aligned"."alignment_id")
SELECT jsonb_build_array("_sids",'Turn',"Turn_id",jsonb_build_object('char_range',"Turn"."char_range",'surname',"Turn"."surname",'forename',"Turn"."forename",'memberId',"Turn"."memberId",'countryCode',"Turn"."countryCode",'isPresident',"Turn"."isPresident",'politicalGroup',"Turn"."politicalGroup",'originalLanguage',"Turn"."originalLanguage")) AS res FROM "Turn"
UNION ALL SELECT jsonb_build_array("_sids",'Segment',"Segment_id",jsonb_build_object('char_range',"Segment"."char_range")) AS res FROM "Segment"
UNION ALL SELECT jsonb_build_array("_sids",'Chapter',"Chapter_id",jsonb_build_object('char_range',"Chapter"."char_range")) AS res FROM "Chapter"
UNION ALL SELECT jsonb_build_array("_sids",'Session',"Session_id",jsonb_build_object('char_range',"Session"."char_range",'date',"Session"."date")) AS res FROM "Session")
SELECT -1::int2 AS rstype, jsonb_build_array(preps."segment_id", preps.id_offset, preps.content, preps.annotations, preps.char_range) FROM preps
UNION ALL
SELECT -2::int2 AS rstype, res FROM meta;
