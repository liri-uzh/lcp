WITH preps AS (SELECT DISTINCT ps."segment_id", ps.id_offset, ps.content, ps.annotations, s2.char_range
        FROM cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3.segmentrest s1
        JOIN cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3."document" c ON c.char_range @> s1.char_range
        JOIN cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3.segment0 s2 ON c.char_range @> s2.char_range AND s2.char_range && int4range(lower(s1.char_range) - 2, upper(s1.char_range) + 2)
        JOIN cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3.prepared_Segment ps ON ps."segment_id" = s2."segment_id"
        WHERE s1."segment_id" = ANY(:sids)
        ORDER BY s2.char_range),
meta AS (WITH "x" AS (SELECT ps.char_range, ps."segment_id" FROM preps ps),
"Topic" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Topic"."topic_id" AS "Topic_id","Topic"."char_range" AS "char_range","Topic"."frame_range" AS "frame_range","Topic_name"."name" AS "name","Topic_urls"."urls" AS "urls",ARRAY(SELECT "Topic_keywords".label FROM "cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3"."topic_labels" "Topic_keywords" WHERE get_bit("Topic"."keywords", 327-"Topic_keywords".bit) > 0) AS "keywords" FROM "x"LEFT JOIN "cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3"."topic" "Topic" ON "Topic"."char_range" && "x"."char_range" LEFT JOIN "cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3"."topic_name" "Topic_name" ON "Topic_name"."name_id" = "Topic"."name_id" LEFT JOIN "cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3"."topic_urls" "Topic_urls" ON "Topic_urls"."urls_id" = "Topic"."urls_id" GROUP BY "Topic_id","Topic_name"."name_id","Topic_urls"."urls_id"),
"Segment" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Segment"."segment_id" AS "Segment_id","Segment"."char_range" AS "char_range","Segment"."frame_range" AS "frame_range","Segment"."meta"::jsonb->'end' AS "end","Segment"."meta"::jsonb->'text' AS "text","Segment"."meta"::jsonb->'start' AS "start","Segment"."meta"::jsonb->'speaker' AS "speaker" FROM "x"LEFT JOIN "cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3"."segment0" "Segment" ON "Segment"."char_range" && "x"."char_range" GROUP BY "Segment_id"),
"Document" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Document"."document_id" AS "Document_id","Document"."char_range" AS "char_range","Document"."frame_range" AS "frame_range","Document"."meta"::jsonb->'end' AS "end","Document"."meta"->>'name' AS "name","Document"."meta"::jsonb->'audio' AS "audio","Document"."meta"::jsonb->'start' AS "start","Document"."meta"::jsonb->'video' AS "video","Document"."media"::jsonb AS "media" FROM "x"LEFT JOIN "cineminds_video_topic__0538f19753ba4303873463b0d6b3dace_3"."document" "Document" ON "Document"."char_range" && "x"."char_range" GROUP BY "Document_id")
SELECT jsonb_build_array("_sids",'Topic',"Topic_id",jsonb_build_object('char_range',"Topic"."char_range",'frame_range',"Topic"."frame_range",'name',"Topic"."name",'urls',"Topic"."urls",'keywords',"Topic"."keywords")) AS res FROM "Topic"
UNION ALL SELECT jsonb_build_array("_sids",'Segment',"Segment_id",jsonb_build_object('char_range',"Segment"."char_range",'frame_range',"Segment"."frame_range",'end',"Segment"."end",'text',"Segment"."text",'start',"Segment"."start",'speaker',"Segment"."speaker")) AS res FROM "Segment"
UNION ALL SELECT jsonb_build_array("_sids",'Document',"Document_id",jsonb_build_object('char_range',"Document"."char_range",'frame_range',"Document"."frame_range",'end',"Document"."end",'name',"Document"."name",'audio',"Document"."audio",'start',"Document"."start",'video',"Document"."video",'media',"Document"."media")) AS res FROM "Document")
SELECT -1::int2 AS rstype, jsonb_build_array(preps."segment_id", preps.id_offset, preps.content, preps.annotations, preps.char_range) FROM preps
UNION ALL
SELECT -2::int2 AS rstype, res FROM meta;
