WITH preps AS (SELECT DISTINCT ps."segment_id", ps.id_offset, ps.content, ps.annotations, s2.char_range
        FROM swissdox_3.segment_derest s1
        JOIN swissdox_3."article_de" c ON c.char_range @> s1.char_range
        JOIN swissdox_3.segment_de0 s2 ON c.char_range @> s2.char_range AND s2.char_range && int8range(lower(s1.char_range) - 2, upper(s1.char_range) + 2)
        JOIN swissdox_3.prepared_segment_de ps ON ps."segment_id" = s2."segment_id"
        WHERE s1."segment_id" = ANY(:sids)
        ORDER BY s2.char_range),
meta AS (WITH "x" AS (SELECT ps.char_range, ps."segment_id" FROM preps ps),
"Article" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Article"."article_id" AS "Article_id","Article"."char_range" AS "char_range","Article"."head" AS "head","Article"."source" AS "source","Article"."pubdate" AS "pubdate","Article"."subhead" AS "subhead","Article"."dateline" AS "dateline","Article"."source_name" AS "source_name","Article"."meta"::jsonb->'SMDId' AS "SMDId","Article"."meta"::jsonb->'author' AS "author","Article"."meta"::jsonb->'doctype' AS "doctype","Article"."meta"::jsonb->'articleId' AS "articleId","Article"."meta"::jsonb->'contentId' AS "contentId","Article"."meta"::jsonb->'articleURL' AS "articleURL","Article"."meta"::jsonb->'otherPubList' AS "otherPubList","Article"."meta"::jsonb->'otherPubCount' AS "otherPubCount" FROM "x"LEFT JOIN "swissdox_3"."article_de" "Article" ON "Article"."char_range" && "x"."char_range" GROUP BY "Article_id"),
"Division" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Division"."division_id" AS "Division_id","Division"."char_range" AS "char_range","Division"."type" AS "type" FROM "x"LEFT JOIN "swissdox_3"."division_de" "Division" ON "Division"."char_range" && "x"."char_range" GROUP BY "Division_id"),
"Segment" AS (SELECT array_agg("x"."segment_id") AS "_sids", "Segment"."segment_id" AS "Segment_id","Segment"."char_range" AS "char_range" FROM "x"LEFT JOIN "swissdox_3"."segment_de0" "Segment" ON "Segment"."char_range" && "x"."char_range" GROUP BY "Segment_id")
SELECT jsonb_build_array("_sids",'Article',"Article_id",jsonb_build_object('char_range',"Article"."char_range",'head',"Article"."head",'source',"Article"."source",'pubdate',"Article"."pubdate",'subhead',"Article"."subhead",'dateline',"Article"."dateline",'source_name',"Article"."source_name",'SMDId',"Article"."SMDId",'author',"Article"."author",'doctype',"Article"."doctype",'articleId',"Article"."articleId",'contentId',"Article"."contentId",'articleURL',"Article"."articleURL",'otherPubList',"Article"."otherPubList",'otherPubCount',"Article"."otherPubCount")) AS res FROM "Article"
UNION ALL SELECT jsonb_build_array("_sids",'Division',"Division_id",jsonb_build_object('char_range',"Division"."char_range",'type',"Division"."type")) AS res FROM "Division"
UNION ALL SELECT jsonb_build_array("_sids",'Segment',"Segment_id",jsonb_build_object('char_range',"Segment"."char_range")) AS res FROM "Segment")
SELECT -1::int2 AS rstype, jsonb_build_array(preps."segment_id", preps.id_offset, preps.content, preps.annotations, preps.char_range) FROM preps
UNION ALL
SELECT -2::int2 AS rstype, res FROM meta;
